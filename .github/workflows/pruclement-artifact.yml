
on: 
  workflow_dispatch:

# Allows external webhook trigger
  repository_dispatch:
    types: [terraform-plan-received]
      
jobs:
  wzi-cli-scan:
    name: "Wiz-cli IaC Scan"
    runs-on: ubuntu-latest
    env:
      SCAN_PATH: "."
      POLICY: "Default IaC policy"
      
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Split branch name
      # example: "https://github.com/pruClement/terraform/actions/runs/13986347053/artifacts/2794018099"
      # run: echo '${{ github.event.client_payload.artifact_url }}'
        id: split
        run : |
          echo 'ORG_NAME="$(echo ${{ github.event.client_payload.artifact_url }} | cut -d/ -f4)"'
          echo 'REPO_NAME="$(echo ${{ github.event.client_payload.artifact_url }} | cut -d/ -f5)"'
          echo 'RUN_ID="$(echo ${{ github.event.client_payload.artifact_url }} | cut -d/ -f8)"'

          echo $ORG_NAME
          echo $REPO_NAME
          echo $RUN_ID
          
      - name: Checking
        run: |
          echo ${{ steps.split.outputs.ORG_NAME }}
          echo ${{ steps.split.outputs.REPO_NAME }}
          echo ${{ steps.split.outputs.RUN_ID }}

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: artifact
          github-token: ${{ secrets.PRUCLEMENT_PAT }}
          repository: ${{ steps.split.outputs.ORG_NAME }} + "/" + ${{ steps.split.outputs.REPO_NAME }}
          run-id: ${{ steps.split.outputs.RUN_ID }}

      - name: unzip
        run: "ls"

    # - name: Download Wiz CLI
    #   run: curl -o wizcli https://downloads.wiz.io/wizcli/latest/wizcli-linux-amd64 && chmod +x wizcli

    # - name: Authenticate to Wiz
    #   run: ./wizcli auth --id "$WIZ_CLIENT_ID" --secret "$WIZ_CLIENT_SECRET"
    #   env:
    #     WIZ_CLIENT_ID: ${{ secrets.WIZ_CLIENT_ID }}
    #     WIZ_CLIENT_SECRET: ${{ secrets.WIZ_CLIENT_SECRET }}

    # - name: Run wiz CLI IaC scan
    #   run: ./wizcli iac scan --path $SCAN_PATH --policy "$POLICY" --policy-hits-only
